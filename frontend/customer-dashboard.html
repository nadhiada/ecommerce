<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ShopEase ‚Äî Dashboard Customer</title>

  <style>
    body { margin:0; font-family:"Segoe UI",sans-serif; background:#f8f9fc; }
    .navbar { background:#fff; padding:18px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,.06); position:sticky; top:0; z-index:20; }
    .nav-logo { font-size:1.7rem; font-weight:bold; color:#4f46e5; }
    .nav-links a { margin-left:25px; text-decoration:none; font-size:1.1rem; color:#444; }
    .nav-links .active { color:#4f46e5; font-weight:bold; }

    .hero { display:flex; justify-content:space-between; align-items:center; padding:70px 40px; background:linear-gradient(120deg,#4f46e5,#6d5af9); color:white; }
    .hero-content h1 { font-size:2.8rem; }

    .featured { padding:50px 30px; }
    .product-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:25px; max-width:1200px; margin:0 auto; }
    .product-card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:center; transition:.3s; }
    .product-card:hover { transform:translateY(-6px); box-shadow:0 10px 25px rgba(0,0,0,.15); }
    .product-card img { width:160px; height:160px; object-fit:cover; border-radius:12px; background:#eee; }
    .product-price { font-size:1.3rem; font-weight:bold; color:#4f46e5; }

    .order-btn {
      margin-top:12px;
      display:inline-block;
      padding:10px 18px; background:#4f46e5; color:white;
      border-radius:6px; text-decoration:none; font-weight:bold;
      transition:.3s; cursor:pointer; border:none;
    }
    .order-btn:hover { background:#372fdb; }

    footer { background:#1f2937; color:#d1d5db; padding:40px 30px; text-align:center; margin-top:40px; }

    /* MODAL */
    #orderModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.4); backdrop-filter:blur(2px);
      justify-content:center; align-items:center; z-index:200;
    }
    #orderModal .modal-box {
      background:white; padding:25px; width:350px;
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2);
      text-align:center; position:relative;
    }
  </style>
</head>

<body>

<header class="navbar">
  <div class="nav-logo">üõçÔ∏è ShopEase</div>
  <nav class="nav-links">
    <a href="customers-dashboard.html" class="active">Home</a>
    <a href="customers-orders.html">Pesanan Saya</a>
    <a href="index.html">Logout</a>
  </nav>
</header>

<section class="hero">
  <div class="hero-content">
    <h1>Selamat Datang di ShopEase!</h1>
    <p>Temukan produk terbaik dan lakukan pemesanan dengan mudah.  
    <br><b>Semua pesanan menggunakan metode pembayaran COD (Cash On Delivery).</b></p>
  </div>
  <div style="font-size:10rem;">üõí</div>
</section>

<section class="featured">
  <h2 style="text-align:center;">Produk Tersedia</h2>
  <div class="product-grid" id="productList">
    <div style="text-align:center;width:100%;color:#777;">Memuat produk...</div>
  </div>
</section>

<footer>
  <h3>ShopEase</h3>
  <p>Belanja mudah, aman, dan terpercaya.</p>
  <p style="opacity:.7;margin-top:10px;">¬© 2025 ShopEase.</p>
</footer>

<!-- ======================= MODAL ORDER ======================= -->
<div id="orderModal">
  <div class="modal-box">

    <h3 id="modalProductName"></h3>
    <p id="modalProductPrice" style="color:#4f46e5;font-weight:bold;"></p>
    <p id="modalProductStock" style="color:#777;"></p>

    <!-- üü¢ KETERANGAN COD -->
    <p style="margin-top:10px;font-weight:bold;color:#10b981;">
      Metode Pembayaran: <span style="color:#059669;">COD (Cash On Delivery)</span>
    </p>
    <p style="font-size:0.85rem; color:#666; margin-top:5px;">
      Pembayaran dilakukan saat barang tiba di rumah Anda.
    </p>

    <label style="display:block;margin-top:15px;font-size:.9rem;">Jumlah</label>
    <input type="number" id="modalQty" value="1" min="1" style="
      width:100%; padding:8px; border-radius:6px; border:1px solid #bbb; margin-bottom:20px;
    ">

    <button id="submitOrderBtn" style="
      width:100%; padding:10px; background:#4f46e5; color:white;
      font-weight:bold; border:none; border-radius:6px; cursor:pointer;
    ">Submit Order</button>

    <button onclick="closeOrderModal()" style="
      margin-top:10px; background:#e5e7eb; border:none; padding:8px 16px;
      border-radius:6px; cursor:pointer;
    ">Batal</button>
  </div>
</div>

<script>
let selectedProduct = null;

function formatRupiah(num) {
  return "Rp " + Number(num || 0).toLocaleString("id-ID");
}

function getEmojiFallback(name = "") {
  name = name.toLowerCase();
  if (name.includes("keyboard")) return "‚å®Ô∏è";
  if (name.includes("mouse")) return "üñ±Ô∏è";
  if (name.includes("monitor")) return "üñ•Ô∏è";
  if (name.includes("headset")) return "üéß";
  return "üõçÔ∏è";
}

// ==================== LOAD PRODUCT ====================
async function loadProducts() {
  const box = document.getElementById("productList");

  try {
    const res = await fetch("http://localhost:3001/api/products");
    const list = await res.json();

    if (!list.length) {
      box.innerHTML = "<div style='text-align:center;width:100%;color:#777;'>Belum ada produk</div>";
      return;
    }

    box.innerHTML = list.map(p => `
      <div class="product-card">
        ${ p.IMAGE_URL
            ? `<img src="http://localhost:3001${p.IMAGE_URL}" alt="${p.NAME}">`
            : `<div style="font-size:5rem;">${getEmojiFallback(p.NAME)}</div>`
        }
        <h3>${p.NAME}</h3>
        <p class="product-price">${formatRupiah(p.PRICE)}</p>
        <p style="font-size:.9rem;color:#777;">Stok: ${p.STOCK}</p>

        <button onclick='openOrderModal(${JSON.stringify(p)})' class="order-btn">Order</button>
      </div>
    `).join("");

  } catch (err) {
    console.log(err);
    box.innerHTML = "<div style='text-align:center;width:100%;color:#777;'>Gagal memuat produk</div>";
  }
}

// ==================== MODAL CONTROL ====================
function openOrderModal(product) {
  selectedProduct = product;

  document.getElementById("modalProductName").innerText = product.NAME;
  document.getElementById("modalProductPrice").innerText = formatRupiah(product.PRICE);
  document.getElementById("modalProductStock").innerText = "Stok tersedia: " + product.STOCK;

  document.getElementById("modalQty").max = product.STOCK;
  document.getElementById("modalQty").value = 1;

  document.getElementById("orderModal").style.display = "flex";
}

function closeOrderModal() {
  document.getElementById("orderModal").style.display = "none";
}

// ==================== SUBMIT ORDER (PAYMENT = COD) ====================
document.getElementById("submitOrderBtn").onclick = async () => {
  const qty = Number(document.getElementById("modalQty").value);
  const p = selectedProduct;

  if (qty < 1 || qty > p.STOCK) {
    alert("Jumlah tidak valid!");
    return;
  }

  // Ambil customer dari localStorage
  const customer = JSON.parse(localStorage.getItem("customer") || "{}");

  if (!customer.customer_id) {
    alert("Session habis, silakan login ulang!");
    return;
  }

  // FORMAT SESUAI BACKEND
  const payload = {
    CUSTOMER_ID: customer.customer_id,
    PAYMENT_METHOD: "COD",
    ITEMS: [
      {
        PRODUCT_ID: p.PRODUCT_ID,
        QUANTITY: qty
      }
    ]
  };

  try {
    const res = await fetch("http://localhost:3001/api/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      alert("Order berhasil dibuat dengan metode COD!");
      closeOrderModal();
      loadProducts(); // refresh stok
    } else {
      alert("Gagal membuat order: " + (data.error || data.message));
    }

  } catch (err) {
    console.log(err);
    alert("Terjadi error saat membuat order!");
  }
};

loadProducts();
</script>

</body>
</html>
